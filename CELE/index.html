<!DOCTYPE html>
<html lang="pl" data-theme="BŁYSK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Centrum Celów 🌱 – Osiągaj z Brianem Tracy</title>
  <meta name="description" content="Aplikacja do wyznaczania i realizacji celów oparta na metodologii Briana Tracy'ego.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400..700;1,400..1000&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap&subset=latin-ext" rel="stylesheet">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎯</text></svg>">
  <meta name="theme-color" content="#27272A">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Centrum Celów">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>

  <style>
    :root{--font-primary:'Inter',sans-serif;--font-secondary:'Lora',serif;--font-ui:'Nunito',sans-serif;--ease-in-out:cubic-bezier(0.4,0,0.2,1);--transition-fast:200ms var(--ease-in-out);--transition-medium:300ms var(--ease-in-out);--priority-high:#EF4444;--priority-low:#22C55E;--priority-pending:#6B7280;}[data-theme="fokus"]{--bg-primary:#18181B;--bg-secondary:#27272A;--bg-tertiary:#3F3F46;--text-primary:#F4F4F5;--text-secondary:#A1A1AA;--text-tertiary:#71717A;--accent-primary:#FBBF24;--accent-secondary:#34D399;--accent-info:#60A5FA;--border-primary:#3F3F46;--shadow-color:rgba(0,0,0,0.35);--priority-pending:#4B5563;}[data-theme="jasny"]{--bg-primary:#F3F4F6;--bg-secondary:#FFFFFF;--bg-tertiary:#F9FAFB;--text-primary:#111827;--text-secondary:#6B7280;--text-tertiary:#9CA3AF;--accent-primary:#3B82F6;--accent-secondary:#10B981;--accent-info:#6366F1;--border-primary:#E5E7EB;--shadow-color:rgba(0,0,0,0.1);--priority-high:#DC2626;--priority-low:#16A34A;--priority-pending:#D1D5DB;}[data-theme="ciemny"]{--bg-primary:#111827;--bg-secondary:#1F2937;--bg-tertiary:#374151;--text-primary:#F9FAFB;--text-secondary:#9CA3AF;--text-tertiary:#6B7280;--accent-primary:#60A5FA;--accent-secondary:#34D399;--accent-info:#818CF8;--border-primary:#374151;--shadow-color:rgba(0,0,0,0.35);--priority-pending:#4B5563;}[data-theme="las"]{--bg-primary:#F0FDF4;--bg-secondary:#FFFFFF;--bg-tertiary:#F7FEE7;--text-primary:#14532D;--text-secondary:#166534;--text-tertiary:#15803D;--accent-primary:#22C55E;--accent-secondary:#84CC16;--accent-info:#3B82F6;--border-primary:#D1FAE5;--shadow-color:rgba(20,83,45,0.1);--priority-high:#DC2626;--priority-low:#16A34A;--priority-pending:#D1D5DB;}[data-theme="ocean"]{--bg-primary:#EFF6FF;--bg-secondary:#FFFFFF;--bg-tertiary:#EBF8FF;--text-primary:#1E3A8A;--text-secondary:#1D4ED8;--text-tertiary:#2563EB;--accent-primary:#3B82F6;--accent-secondary:#2DD4BF;--accent-info:#60A5FA;--border-primary:#DBEAFE;--shadow-color:rgba(30,58,138,0.1);--priority-high:#DC2626;--priority-low:#16A34A;--priority-pending:#D1D5DB;}[data-theme="blask"]{--bg-primary:#FFFBEB;--bg-secondary:#FFFFFF;--bg-tertiary:#FEFCE8;--text-primary:#78350F;--text-secondary:#9A3412;--text-tertiary:#B45309;--accent-primary:#F59E0B;--accent-secondary:#F97316;--accent-info:#3B82F6;--border-primary:#FEF08A;--shadow-color:rgba(120,53,15,0.1);--priority-high:#DC2626;--priority-low:#16A34A;--priority-pending:#D1D5DB;}*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}body{background-color:var(--bg-primary);color:var(--text-primary);font-family:var(--font-ui);-webkit-font-smoothing:antialiased;line-height:1.6;overscroll-behavior:none;min-height:100vh;transition:background-color var(--transition-medium),color var(--transition-medium)}#main-app{display:flex;flex-direction:column;min-height:100vh}.container{max-width:800px;width:100%;margin:0 auto;padding:1.5rem 1rem;display:flex;flex-direction:column;flex-grow:1}header.main-header{text-align:center;margin-bottom:2rem;flex-shrink:0;background-image:linear-gradient(rgba(0,0,0,0.2),rgba(0,0,0,0.5)),url('https://images.pexels.com/photos/1274260/pexels-photo-1274260.jpeg');background-size:cover;background-position:center;padding:3rem 1.5rem;border-radius:16px;box-shadow:0 10px 15px -3px var(--shadow-color)}header.main-header h1,header.main-header .header-subtitle,header.main-header .quote{color:#fff;text-shadow:1px 1px 4px rgba(0,0,0,0.7)}header.main-header .header-subtitle{color:rgba(255,255,255,0.9)}header.main-header .quote{color:rgba(255,255,255,0.8);margin-top:1.5rem}header.main-header h1{font-family:var(--font-secondary);font-size:2.5rem;font-weight:700;line-height:1.2}.header-subtitle{font-size:1rem;margin-top:0.25rem}.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;font-family:var(--font-ui);font-weight:600;padding:.5rem 1rem;border:1px solid transparent;border-radius:8px;cursor:pointer;text-decoration:none;transition:background-color var(--transition-fast),color var(--transition-fast),border-color var(--transition-fast),transform var(--transition-fast);white-space:nowrap}.btn:hover{transform:translateY(-2px)}.btn:focus-visible{outline:2px solid var(--accent-info);outline-offset:2px}.btn-primary{background-color:var(--accent-primary);color:var(--bg-primary)}.btn-primary:hover{filter:brightness(1.1)}.btn-secondary{background-color:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-primary)}.btn-secondary:hover{background-color:var(--bg-tertiary)}.btn-icon{padding:.5rem;background-color:var(--bg-secondary);border:1px solid var(--border-primary);color:var(--text-secondary)}.btn-icon:hover{background-color:var(--bg-tertiary);color:var(--text-primary)}input,select,textarea{background:var(--bg-secondary);border:1px solid var(--border-primary);border-radius:8px;padding:.5rem .75rem;font-family:var(--font-ui);color:var(--text-primary);transition:border-color var(--transition-fast),box-shadow var(--transition-fast);width:100%}.form-group textarea{min-height:100px;resize:vertical}input:focus,select:focus,textarea:focus{border-color:var(--accent-primary);box-shadow:0 0 0 2px var(--accent-primary);outline:none}.daily-entry{background-color:var(--bg-secondary);border:1px solid var(--border-primary);border-radius:12px;padding:1.25rem;margin-bottom:1.5rem;box-shadow:0 4px 6px -1px var(--shadow-color)}.daily-entry h2{font-family:var(--font-secondary);font-size:1.3rem;margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between}.save-status{font-size:.8rem;color:var(--text-tertiary);opacity:0;transition:opacity var(--transition-fast)}.save-status.is-visible{opacity:1}.goals-list{display:flex;flex-direction:column;gap:1rem}.goal-card{background-color:var(--bg-secondary);border-radius:12px;border:1px solid var(--border-primary);box-shadow:0 4px 6px -1px var(--shadow-color);transition:transform var(--transition-fast),box-shadow var(--transition-fast),background-color var(--transition-fast);position:relative;overflow:hidden}.goal-card::before{content:'';position:absolute;top:0;left:0;width:5px;height:100%;background-color:transparent;transition:background-color var(--transition-fast)}.goal-card[data-priority="wysoki"]::before{background-color:var(--priority-high)}.goal-card[data-priority="niski"]::before{background-color:var(--priority-low)}.goal-card:hover{transform:translateY(-2px);box-shadow:0 10px 15px -3px var(--shadow-color)}.goal-card.completed{background-color:var(--bg-tertiary);opacity:.8}.goal-card.completed .goal-title,.goal-card.completed .goal-details{text-decoration:line-through;color:var(--text-tertiary)}.goal-header{width:100%;background:none;border:none;padding:1.25rem;display:flex;align-items:center;gap:1rem;text-align:left;border-radius:12px;padding-left:1.25rem}.goal-header-main{display:flex;flex-grow:1;align-items:center;gap:1rem;cursor:pointer}.goal-header-main:focus-visible{outline:2px solid var(--accent-info);outline-offset:-2px;border-radius:8px}.goal-completion-checkbox{flex-shrink:0;width:24px;height:24px;accent-color:var(--accent-secondary);cursor:pointer}.goal-content{flex-grow:1}.goal-title{font-size:1.1rem;font-weight:600;font-family:var(--font-primary);color:var(--text-primary)}.goal-details{font-size:.9rem;color:var(--text-secondary)}.goal-actions{display:flex;gap:.5rem;margin-left:auto}.goal-plan{display:grid;grid-template-rows:0fr;transition:grid-template-rows var(--transition-medium)}.goal-plan-content{overflow:hidden}.goal-card[aria-expanded="true"] .goal-plan{grid-template-rows:1fr}.steps-list{list-style:none;padding:0 1.25rem 1.25rem;display:flex;flex-direction:column;gap:.75rem;border-top:1px solid var(--border-primary);margin:0 1.25rem}.step-item{display:flex;align-items:center;gap:.75rem}.step-item label{color:var(--text-primary);cursor:pointer}.step-item input[type="checkbox"]:checked+label{text-decoration:line-through;color:var(--text-tertiary)}.step-checkbox{flex-shrink:0;width:20px;height:20px;border:2px solid var(--border-primary);border-radius:4px;cursor:pointer}.modal-overlay{position:fixed;inset:0;background-color:rgba(0,0,0,.6);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:opacity var(--transition-medium),visibility var(--transition-medium);z-index:1000}.modal-overlay.is-visible{opacity:1;visibility:visible}.modal-content{background-color:var(--bg-secondary);border:1px solid var(--border-primary);border-radius:12px;padding:2rem;width:90%;max-width:600px;box-shadow:0 20px 25px -5px var(--shadow-color),0 8px 10px -6px var(--shadow-color);transform:scale(.95);transition:transform var(--transition-medium)}.modal-overlay.is-visible .modal-content{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}.modal-title{font-family:var(--font-secondary);font-size:1.5rem;font-weight:600}.form-group{margin-bottom:1rem}.form-group label{display:block;font-weight:600;margin-bottom:.5rem;font-size:.9rem}.modal-actions{display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.5rem}.delete-action{margin-right:auto}.chart-container{position:relative;height:40vh;min-height:300px;width:100%;margin-top:1.5rem}footer{text-align:center;padding:1.5rem 1rem;margin-top:2rem;font-size:.9rem;color:var(--text-tertiary);border-top:1px solid var(--border-primary);flex-shrink:0}

    /* === NOWE STYLE DLA NAGŁÓWKA === */
    .app-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-primary); gap: 1rem; position: relative; width: 100%; }
    .header-nav { display: flex; align-items: center; gap: 0.5rem; border: 1px solid var(--border-primary); background-color: var(--bg-secondary); padding: 0.375rem; border-radius: 99px; flex-shrink: 0; }
    .nav-icon { display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; color: var(--text-tertiary); background-color: transparent; border-radius: 50%; transition: all 0.2s ease; text-decoration: none; }
    .nav-icon:hover { color: var(--text-primary); background-color: var(--bg-tertiary); }
    .nav-icon.active { color: var(--accent-primary); background-color: var(--bg-tertiary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header-date-controls { display: flex; align-items: center; gap: 0.5rem; position: absolute; left: 50%; transform: translateX(-50%); }
    .header-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
    .header-date-controls input[type="date"] { font-family: var(--font-ui); font-weight: 600; font-size: 1rem; text-align: center; background-color: var(--bg-secondary); border: 1px solid var(--border-primary); color: var(--text-primary); padding: 0.35rem; border-radius: 6px; width: 155px; transition: background-color var(--transition-fast); }
    .header-date-controls input[type="date"]:hover { background-color: var(--bg-tertiary); }
    .header-date-controls input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; }
    @media (max-width: 768px) {
        .header-date-controls { position: static; transform: none; order: 2; width: 100%; justify-content: center; }
        .app-header { flex-wrap: wrap; }
        .header-nav { order: 1; }
        .header-actions { order: 1; margin-left: auto; }
    }
    .add-goal-container {
        margin-bottom: 1.5rem; /* Dodaje odstęp pod przyciskiem */
        display: flex;
        justify-content: center;
    }
    .add-goal-container .btn {
        width: 100%; /* Rozciąga przycisk na 100% szerokości */
        max-width: 500px; /* Opcjonalnie: ogranicza maksymalną szerokość na dużych ekranach */
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        font-size: 1rem;
    }

  </style>
</head>
<body>

  <div id="main-app">
    <div class="container">
      <header class="main-header">
        <h1>Centrum Celów 🌱</h1>
        <p class="header-subtitle">Metodologia Briana Tracy'ego w Twoim zasięgu</p>
        <p class="quote">"Kluczem do sukcesu jest skupienie umysłu na tym, czego pragniemy, a nie na tym, czego się obawiamy."</p>
      </header>

      <header class="app-header">
        <!-- CZĘŚĆ LEWA: Nawigacja -->
                <nav class="header-nav" aria-label="Główna nawigacja">
                    <a href="/" class="nav-icon" aria-label="Strona Główna" title="Strona Główna">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M6.5 14.5v-3.505c0-.245.25-.495.5-.495h2c.25 0 .5.25.5.495v3.505A.5.5 0 0 0 10 15h2a.5.5 0 0 0 .5-.5V8.207l-5-5L2 8.207V14.5a.5.5 0 0 0 .5.5H5a.5.5 0 0 0 .5-.5z"/></svg>
                    </a>
                    <a href="dziennik/public/" class="nav-icon" aria-label="Dziennik" title="Dziennik">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>
                    </a>
                    <a href="cele/" class="nav-icon active" aria-label="Cele" title="Cele">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm0 1a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/><path d="M8 6a2 2 0 1 1 0 4 2 2 0 0 1 0-4zm0 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/></svg>
                    </a>
                    <a href="wizja/" class="nav-icon" aria-label="Wizja" title="Wizja">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>
                    </a>
                </nav>
         
          
          <div class="header-date-controls">
              <button class="btn btn-secondary" id="prev-day-btn" aria-label="Poprzedni dzień">←</button>
              <input type="date" id="currentDate">
              <button class="btn btn-secondary" id="next-day-btn" aria-label="Następny dzień">→</button>
          </div>

          <div class="header-actions">
              <select id="theme-switcher" aria-label="Wybierz motyw" style="height: 38px;">
                  <option value="fokus">Fokus</option><option value="jasny">Jasny</option><option value="ciemny">Ciemny</option><option value="las">Las</option><option value="ocean">Ocean</option><option value="blask">Blask</option>
              </select>
              <button class="btn btn-secondary" id="show-chart-btn" aria-label="Wykres">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2z"/></svg>
              </button>
              </div>
      </header>

      <main>
            <div class="add-goal-container">
        <button class="btn btn-primary" id="add-goal-btn">+ Nowy Cel</button>
    </div>
    <h2 style="...">Twoje Aktywne Cele</h2>
    <div class="goals-list" id="goals-list">
        </div>
</main>
        <h2 style="font-family: var(--font-secondary); margin-bottom: 1rem; font-size: 1.3rem;">Cele na ten dzień</h2>
        <div class="goals-list" id="goals-list">
          </div>

        <div class="daily-entry" style="margin-top: 2rem;">
          <h2>Rytuał Dzienny <span class="save-status" id="ritual-save-status">✓ Zapisano</span></h2>
          <div class="form-group">
            <textarea id="daily-ritual-textarea" placeholder="Wpisz swoje poranne lub wieczorne rytuały..."></textarea>
          </div>
        </div>

        <div class="daily-entry" style="margin-top: 1.5rem;">
            <h2>Podsumowanie Dnia <span class="save-status" id="summary-save-status">✓ Zapisano</span></h2>
            <div class="form-group">
                <textarea id="daily-summary-textarea" placeholder="Co dziś poszło dobrze? Czego się nauczyłeś/aś?"></textarea>
            </div>
        </div>
      </main>
    </div>
    
    <footer>
      <p>&copy; 2025 Centrum Celów. Stworzone z inspiracji naukami Briana Tracy'ego.</p>
    </footer>
  </div>

  <div class="modal-overlay" id="goal-modal" role="dialog" aria-modal="true" aria-labelledby="goal-modal-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="goal-modal-title">Nowy cel</h2>
        <button class="btn btn-icon" id="close-goal-modal-btn" aria-label="Zamknij"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
      </div>
      <form id="goal-form">
        <input type="hidden" id="goal-id-input">
        <div class="form-group">
          <label for="goal-title-input">Nazwa celu</label>
          <input type="text" id="goal-title-input" placeholder="Np. Ukończyć ważny projekt" required>
        </div>
        <div class="form-group">
            <label for="goal-priority-select">Priorytet</label>
            <select id="goal-priority-select">
                <option value="niski" selected>Niski</option>
                <option value="wysoki">Wysoki</option>
            </select>
        </div>
        <div class="form-group">
          <label for="goal-details-input">Szczegóły (opcjonalne)</label>
          <input type="text" id="goal-details-input" placeholder="Np. Cel biznesowy">
        </div>
        <div class="form-group">
            <label for="goal-steps-input">Kroki do wykonania (każdy w nowej linii)</label>
            <textarea id="goal-steps-input" placeholder="1. Zdefiniować wymagania&#10;2. Stworzyć harmonogram&#10;3. Zaimplementować funkcję X"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary delete-action" id="delete-goal-btn" style="color: #F87171; display: none;">Usuń cel</button>
          <button type="button" class="btn btn-secondary" id="cancel-modal-btn">Anuluj</button>
          <button type="submit" class="btn btn-primary">Zapisz</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="chart-modal" role="dialog" aria-modal="true" aria-labelledby="chart-modal-title">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title" id="chart-modal-title">Postępy w tym miesiącu</h2>
        <button class="btn btn-icon" id="close-chart-modal-btn" aria-label="Zamknij"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
      </div>
      <div class="chart-container">
        <canvas id="goals-chart"></canvas>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            state: {
                currentDate: new Date(),
                goals: [],
                dailyEntries: {},
                lastFocusedElement: null,
                chartInstance: null,
            },
            
            init() {
                this.loadState();
                this.initDateControls();
                this.initThemeSwitcher();
                this.initModals();
                this.initEventListeners();
                this.renderAll();
            },

            loadState() {
                try {
                    const savedGoals = localStorage.getItem('goals');
                    this.state.goals = savedGoals ? JSON.parse(savedGoals) : [];
                    const savedEntries = localStorage.getItem('dailyEntries');
                    this.state.dailyEntries = savedEntries ? JSON.parse(savedEntries) : {};
                } catch (e) { console.error("Failed to load state", e); }
            },

            saveState() {
                try {
                    localStorage.setItem('goals', JSON.stringify(this.state.goals));
                    localStorage.setItem('dailyEntries', JSON.stringify(this.state.dailyEntries));
                } catch (e) {
                    console.error("Failed to save state", e);
                    alert("Wystąpił błąd podczas zapisywania danych.");
                }
            },
            
            getDateKey(date) { return date.toISOString().split('T')[0]; },

            initDateControls() {
                const dateInput = document.getElementById('currentDate');
                const prevDayBtn = document.getElementById('prev-day-btn');
                const nextDayBtn = document.getElementById('next-day-btn');
                const updateDate = (newDate, oldDate) => {
                    this.state.currentDate = newDate;
                    dateInput.value = this.getDateKey(this.state.currentDate);
                    const newDateKey = this.getDateKey(newDate);
                    const oldDateKey = this.getDateKey(oldDate);
                    if (!this.state.dailyEntries[newDateKey] || !this.state.dailyEntries[newDateKey].ritual) {
                        const oldRitual = this.state.dailyEntries[oldDateKey]?.ritual || '';
                        if (oldRitual) {
                            if (!this.state.dailyEntries[newDateKey]) this.state.dailyEntries[newDateKey] = {};
                            this.state.dailyEntries[newDateKey].ritual = oldRitual;
                            this.saveState();
                        }
                    }
                    this.renderAll();
                };
                prevDayBtn.addEventListener('click', () => {
                    const oldDate = new Date(this.state.currentDate);
                    const newDate = new Date(this.state.currentDate); newDate.setDate(newDate.getDate() - 1);
                    updateDate(newDate, oldDate);
                });
                nextDayBtn.addEventListener('click', () => {
                    const oldDate = new Date(this.state.currentDate);
                    const newDate = new Date(this.state.currentDate); newDate.setDate(newDate.getDate() + 1);
                    updateDate(newDate, oldDate);
                });
                dateInput.addEventListener('change', () => {
                    const oldDate = new Date(this.state.currentDate);
                    const selectedDate = new Date(dateInput.value);
                    const newDate = new Date(selectedDate.getTime() + selectedDate.getTimezoneOffset() * 60000);
                    updateDate(newDate, oldDate);
                });
                dateInput.value = this.getDateKey(this.state.currentDate);
            },

            initThemeSwitcher() {
                const themeSwitcher = document.getElementById('theme-switcher');
                const htmlElement = document.documentElement;
                const savedTheme = localStorage.getItem('theme') || 'fokus';
                htmlElement.setAttribute('data-theme', savedTheme);
                themeSwitcher.value = savedTheme;
                themeSwitcher.addEventListener('change', (e) => {
                    htmlElement.setAttribute('data-theme', e.target.value);
                    localStorage.setItem('theme', e.target.value);
                });
            },

            debounce(func, delay = 800) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            },

            showSaveStatus(elementId) {
                const statusEl = document.getElementById(elementId);
                if (statusEl) {
                    statusEl.classList.add('is-visible');
                    setTimeout(() => statusEl.classList.remove('is-visible'), 2000);
                }
            },

            initModals() {
                const goalModal = {
                    overlay: document.getElementById('goal-modal'), openBtn: document.getElementById('add-goal-btn'),
                    closeBtn: document.getElementById('close-goal-modal-btn'), cancelBtn: document.getElementById('cancel-modal-btn'),
                    form: document.getElementById('goal-form'), deleteBtn: document.getElementById('delete-goal-btn'),
                    title: document.getElementById('goal-modal-title')
                };
                const chartModal = {
                    overlay: document.getElementById('chart-modal'), openBtn: document.getElementById('show-chart-btn'),
                    closeBtn: document.getElementById('close-chart-modal-btn')
                };

                const setupModal = (modalElements) => {
                    const open = () => {
                        this.state.lastFocusedElement = document.activeElement;
                        modalElements.overlay.classList.add('is-visible');
                        if (modalElements.form) modalElements.form.querySelector('input, select').focus();
                    };
                    const close = () => {
                        modalElements.overlay.classList.remove('is-visible');
                        if (this.state.lastFocusedElement) this.state.lastFocusedElement.focus();
                    };
                    modalElements.openBtn.addEventListener('click', () => {
                        if (modalElements.form) {
                            modalElements.form.reset();
                            modalElements.form.querySelector('#goal-id-input').value = '';
                            modalElements.title.textContent = 'Nowy cel';
                            modalElements.deleteBtn.style.display = 'none';
                            document.getElementById('goal-priority-select').value = 'niski';
                        }
                        if (modalElements.overlay.id === 'chart-modal') this.renderChart();
                        open();
                    });
                    modalElements.closeBtn.addEventListener('click', close);
                    if (modalElements.cancelBtn) modalElements.cancelBtn.addEventListener('click', close);
                    modalElements.overlay.addEventListener('click', e => e.target === modalElements.overlay && close());
                    modalElements.overlay.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });
                };
                
                setupModal(goalModal);
                setupModal(chartModal);

                goalModal.form.addEventListener('submit', (e) => { e.preventDefault(); this.saveGoal(); goalModal.overlay.classList.remove('is-visible'); });
                goalModal.deleteBtn.addEventListener('click', () => {
                    if (confirm('Czy na pewno chcesz usunąć ten cel?')) { this.deleteGoal(); goalModal.overlay.classList.remove('is-visible'); }
                });
            },

            saveGoal() {
                const id = document.getElementById('goal-id-input').value;
                const title = document.getElementById('goal-title-input').value.trim();
                if (!title) return; 
                const details = document.getElementById('goal-details-input').value.trim();
                const priority = document.getElementById('goal-priority-select').value;
                const stepsText = document.getElementById('goal-steps-input').value;
                const newStepTexts = stepsText.split('\n').map(t => t.trim()).filter(Boolean);

                if (id) {
                    const goal = this.state.goals.find(g => g.id === id);
                    if (goal) {
                        const updatedSteps = newStepTexts.map(text => {
                            return goal.steps.find(s => s.text === text) || { id: `step-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`, text, completed: false };
                        });
                        goal.title = title; goal.details = details; goal.priority = priority; goal.steps = updatedSteps;
                    }
                } else {
                    this.state.goals.push({
                        id: `goal-${Date.now()}`, title, details, priority, completedOn: null,
                        steps: newStepTexts.map(text => ({ id: `step-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`, text, completed: false })),
                        createdAt: this.getDateKey(this.state.currentDate)
                    });
                }
                this.saveState();
                this.renderGoals();
            },

            deleteGoal() {
                this.state.goals = this.state.goals.filter(g => g.id !== document.getElementById('goal-id-input').value);
                this.saveState(); this.renderGoals();
            },

            openGoalForEdit(goalId) {
                const goal = this.state.goals.find(g => g.id === goalId);
                if (!goal) return;
                const modal = document.getElementById('goal-modal');
                document.getElementById('goal-modal-title').textContent = 'Edytuj cel';
                document.getElementById('goal-id-input').value = goal.id;
                document.getElementById('goal-title-input').value = goal.title;
                document.getElementById('goal-details-input').value = goal.details;
                document.getElementById('goal-priority-select').value = goal.priority || 'niski';
                document.getElementById('goal-steps-input').value = goal.steps.map(s => s.text).join('\n');
                document.getElementById('delete-goal-btn').style.display = 'block';
                this.state.lastFocusedElement = document.activeElement;
                modal.classList.add('is-visible');
                document.getElementById('goal-title-input').focus();
            },
            
            initEventListeners() {
                const goalsList = document.getElementById('goals-list');
                const ritualTextarea = document.getElementById('daily-ritual-textarea');
                const summaryTextarea = document.getElementById('daily-summary-textarea');
                
                const debouncedSave = (value, dateKey, type) => {
                    if (!this.state.dailyEntries[dateKey]) this.state.dailyEntries[dateKey] = {};
                    this.state.dailyEntries[dateKey][type] = value;
                    this.saveState(); this.showSaveStatus(`${type}-save-status`);
                };
                ritualTextarea.addEventListener('input', this.debounce(() => debouncedSave(ritualTextarea.value, this.getDateKey(this.state.currentDate), 'ritual')));
                summaryTextarea.addEventListener('input', this.debounce(() => debouncedSave(summaryTextarea.value, this.getDateKey(this.state.currentDate), 'summary')));

                goalsList.addEventListener('click', e => {
                    const headerMain = e.target.closest('.goal-header-main');
                    const editBtn = e.target.closest('.edit-goal-btn');
                    const goalCheckbox = e.target.closest('.goal-completion-checkbox');
                    if (e.target.matches('.step-checkbox')) {
                       const goal = this.state.goals.find(g => g.id === e.target.dataset.goalId);
                       const step = goal?.steps.find(s => s.id === e.target.dataset.stepId);
                       if (step) { step.completed = e.target.checked; this.saveState(); } return;
                    }
                    if (headerMain) {
                        const card = headerMain.closest('.goal-card');
                        card.setAttribute('aria-expanded', card.getAttribute('aria-expanded') !== 'true');
                    }
                    if (editBtn) this.openGoalForEdit(editBtn.dataset.goalId);
                    if (goalCheckbox) {
                        const goal = this.state.goals.find(g => g.id === goalCheckbox.dataset.goalId);
                        if (goal) {
                           goal.completedOn = goalCheckbox.checked ? this.getDateKey(this.state.currentDate) : null;
                           this.saveState(); this.renderGoals();
                        }
                    }
                });
            },

            renderAll() { this.renderDailyEntries(); this.renderGoals(); },

            renderDailyEntries() {
                const dateKey = this.getDateKey(this.state.currentDate);
                const entries = this.state.dailyEntries[dateKey] || {};
                document.getElementById('daily-ritual-textarea').value = entries.ritual || '';
                document.getElementById('daily-summary-textarea').value = entries.summary || '';
            },

            renderGoals() {
                const goalsList = document.getElementById('goals-list');
                const dateKey = this.getDateKey(this.state.currentDate);
                const goalsForToday = this.state.goals.filter(goal => (goal.completedOn === dateKey) || (!goal.completedOn && goal.createdAt <= dateKey));
                if (goalsForToday.length === 0) {
                    goalsList.innerHTML = `<p style="color: var(--text-tertiary); text-align: center;">Brak celów na dziś. Dodaj nowy, aby zacząć!</p>`; return;
                }
                const priorityMap = { 'wysoki': 1, 'niski': 2 };
                goalsForToday.sort((a, b) => (a.completedOn ? 1 : -1) - (b.completedOn ? 1 : -1) || (priorityMap[a.priority] || 2) - (priorityMap[b.priority] || 2));
                goalsList.innerHTML = goalsForToday.map(goal => {
                    const isCompleted = !!goal.completedOn;
                    return `
                    <article class="goal-card ${isCompleted ? 'completed' : ''}" id="${goal.id}" data-priority="${goal.priority || 'niski'}" aria-expanded="false">
                        <div class="goal-header">
                            <input type="checkbox" class="goal-completion-checkbox" data-goal-id="${goal.id}" aria-label="Oznacz cel ${goal.title} jako ukończony" ${isCompleted ? 'checked' : ''}>
                            <div class="goal-header-main" role="button" tabindex="0" aria-controls="plan-${goal.id}" aria-expanded="false">
                                <div class="goal-content"><div class="goal-title">${goal.title}</div><p class="goal-details">${goal.details}</p></div>
                            </div>
                            <div class="goal-actions"><button class="btn btn-icon edit-goal-btn" data-goal-id="${goal.id}" aria-label="Edytuj cel ${goal.title}"><svg fill="currentColor" width="16" height="16" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg></button></div>
                        </div>
                        <div class="goal-plan" id="plan-${goal.id}"><div class="goal-plan-content">${goal.steps.length > 0 ? `<ul class="steps-list">${goal.steps.map(step => `<li class="step-item"><input type="checkbox" class="step-checkbox" id="${step.id}" data-goal-id="${goal.id}" data-step-id="${step.id}" ${step.completed ? 'checked' : ''}><label for="${step.id}">${step.text}</label></li>`).join('')}</ul>` : '<p style="padding:0 1.25rem 1.25rem;font-size:.9rem;color:var(--text-tertiary);">Brak kroków.</p>'}</div></div>
                    </article>`;
                }).join('');
                goalsList.querySelectorAll('.goal-card .goal-header-main').forEach(header => header.setAttribute('aria-expanded', header.closest('.goal-card').getAttribute('aria-expanded')));
            },
            
            generateChartData() {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const labels = Array.from({ length: daysInMonth }, (_, i) => `${i + 1}`);
                
                const completedHigh = new Array(daysInMonth).fill(0);
                const completedLow = new Array(daysInMonth).fill(0);
                const pendingHigh = new Array(daysInMonth).fill(0);
                const pendingLow = new Array(daysInMonth).fill(0);

                for (let i = 0; i < daysInMonth; i++) {
                    const day = i + 1;
                    const dateKey = this.getDateKey(new Date(year, month, day));
                    
                    this.state.goals.forEach(goal => {
                        if (goal.createdAt <= dateKey) {
                            if (goal.completedOn === dateKey) {
                                if (goal.priority === 'wysoki') completedHigh[i]++; else completedLow[i]++;
                            } else if (!goal.completedOn || goal.completedOn > dateKey) {
                                if (goal.priority === 'wysoki') pendingHigh[i]++; else pendingLow[i]++;
                            }
                        }
                    });
                }
                return { labels, completedHigh, completedLow, pendingHigh, pendingLow };
            },

            renderChart() {
                const ctx = document.getElementById('goals-chart').getContext('2d');
                if (this.state.chartInstance) this.state.chartInstance.destroy();
                const { labels, completedHigh, completedLow, pendingHigh, pendingLow } = this.generateChartData();
                const style = getComputedStyle(document.body);

                const hexToRgba = (hex, alpha) => {
                    const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                }

                const highColor = style.getPropertyValue('--priority-high').trim();
                const lowColor = style.getPropertyValue('--priority-low').trim();
                
                this.state.chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Ukończone (Wysoki P.)', data: completedHigh, backgroundColor: highColor },
                            { label: 'Ukończone (Niski P.)', data: completedLow, backgroundColor: lowColor },
                            { label: 'Oczekujące (Wysoki P.)', data: pendingHigh, backgroundColor: hexToRgba(highColor, 0.4) },
                            { label: 'Oczekujące (Niski P.)', data: pendingLow, backgroundColor: hexToRgba(lowColor, 0.5) }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, stacked: true, ticks: { stepSize: 1, color: style.getPropertyValue('--text-tertiary') }, grid: { color: style.getPropertyValue('--border-primary') } },
                            x: { stacked: true, ticks: { color: style.getPropertyValue('--text-tertiary') }, grid: { color: 'transparent' } }
                        },
                        plugins: {
                            legend: { labels: { color: style.getPropertyValue('--text-secondary') } },
                            tooltip: {
                                mode: 'index', intersect: false,
                                backgroundColor: style.getPropertyValue('--bg-secondary'), titleColor: style.getPropertyValue('--text-primary'),
                                bodyColor: style.getPropertyValue('--text-secondary'), displayColors: true,
                                borderColor: style.getPropertyValue('--border-primary'), borderWidth: 1
                            }
                        }
                    }
                });
            }
        };
        App.init();
    });
  </script>
</body>
</html>