<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Daily Growth 2.0 üå± ‚Äì Wersja Stabilna</title>
    <meta name="description" content="Aplikacja Daily Growth to Tw√≥j osobisty dziennik rozwoju. ≈öled≈∫ postƒôpy, nawyki, analizuj trendy i buduj lepszƒÖ wersjƒô siebie.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå±</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>
    <style>
/* === NOWY, PROFESJONALNY STYL DLA DAILY GROWTH 2.0 === */
:root {
    /* Paleta kolor√≥w - Light Mode */
    --bg-light: #fdfdfd;
    --card-light: #ffffff;
    --text-light: #212529;
    --text-muted: #6c757d;
    --primary: #2c6e49; /* G≈Çƒôboka, spokojna ziele≈Ñ */
    --accent: #f9a620;  /* Ciep≈Çe, motywujƒÖce z≈Çoto */
    --border-color-light: #dee2e6;
    
    /* Paleta kolor√≥w - Dark Mode */
    --bg-dark: #12181b;
    --card-dark: #1a2226;
    --text-dark: #e8e8e8;
    --text-muted-dark: #adb5bd;
    --border-color-dark: #495057;

    /* Ustawienia globalne */
    --border-radius-sm: 8px;
    --border-radius-md: 16px;
    --box-shadow: 0px 4px 25px rgba(0, 0, 0, 0.05);
    --transition-speed: 0.2s ease-in-out;
}

html.dark-mode {
    --bg-light: var(--bg-dark);
    --card-light: var(--card-dark);
    --text-light: var(--text-dark);
    --text-muted: var(--text-muted-dark);
    --border-color-light: var(--border-color-dark);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
}

body {
    background: var(--bg-light);
    color: var(--text-light);
    line-height: 1.6;
}

.hidden { display: none !important; }

/* === KONTENER I G≈Å√ìWNE ELEMENTY === */
.container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px 15px;
}

header {
    background: var(--primary);
    color: white;
    border-radius: var(--border-radius-md);
    padding: 40px 30px;
    margin: 20px 0 40px 0;
    box-shadow: var(--box-shadow);
}

header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 15px;
}

.quote {
    font-style: italic;
    font-size: 1.1rem;
    opacity: 0.8;
    max-width: 600px;
    margin: 15px auto 0 auto;
    background: transparent;
    padding: 0;
}

/* === KONTROLKI I PRZYCISKI === */
.controls {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
    align-items: center;
    margin: 25px 0;
}

.btn {
    padding: 12px 24px;
    border-radius: var(--border-radius-sm);
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-decoration: none;
    transition: transform var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed);
}

.btn-primary {
    background: var(--primary);
    color: white;
}
.btn-primary:hover {
    background: #3a8d5f; /* Ja≈õniejsza ziele≈Ñ */
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(44, 110, 73, 0.2);
}

.btn-secondary {
    background: var(--accent);
    color: #12181b;
}
.btn-secondary:hover {
    background: #ffb947; /* Ja≈õniejsze z≈Çoto */
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(249, 166, 32, 0.2);
}

/* === ZAK≈ÅADKI === */
.tabs {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin: 40px 0;
    padding-bottom: 5px;
}

.tab {
    padding: 10px 24px;
    border-radius: var(--border-radius-sm);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    font-weight: 600;
    border: 2px solid transparent;
}

.tab.active {
    background: var(--card-light);
    color: var(--primary);
    border: 2px solid var(--primary);
    box-shadow: 0 2px 8px rgba(44, 110, 73, 0.1);
}

html.dark-mode .tab.active {
    color: var(--accent);
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(249, 166, 32, 0.1);
}

/* === SEKCJE I KARTY === */
.section { display: none; }
.section.active { display: block; }

.time-section, .auth-container, .statistics, .modal-content {
    background: var(--card-light);
    padding: 40px;
    border-radius: var(--border-radius-md);
    margin-bottom: 25px;
    box-shadow: var(--box-shadow);
    border: 1px solid var(--border-color-light);
}

.time-header {
    font-size: 1.8rem;
    margin-bottom: 30px;
    color: var(--primary);
    font-weight: 700;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color-light);
}

/* === FORMULARZE === */
textarea, input[type="date"], select, .auth-form input {
    width: 100%;
    padding: 15px;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--border-color-light);
    background: var(--bg-light);
    color: var(--text-light);
    font-size: 1rem;
    transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
}
textarea:focus, input[type="date"]:focus, select:focus, .auth-form input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 110, 73, 0.15);
}
html.dark-mode textarea:focus, html.dark-mode input[type="date"]:focus, html.dark-mode select:focus, html.dark-mode .auth-form input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(249, 166, 32, 0.2);
}

textarea {
    min-height: 120px;
    resize: vertical;
}

label.question {
    display: block;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--text-light);
}

.question-group {
    margin-bottom: 25px;
}

/* === POZOSTA≈ÅE STYLE === */
.summary-block { margin-top: 30px; padding-top: 25px; border-top: 1px solid var(--border-color-light); }
.summary-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 20px; color: var(--primary); }
.chart-container { height: 350px; margin-top: 20px; }
.modal { backdrop-filter: blur(5px); }
.notification { background: var(--primary); box-shadow: var(--box-shadow); }
.auth-container { border: none; }
.auth-toggle button { color: var(--primary); }
.close-modal-btn { color: var(--text-muted); }

/* === MEDIA QUERIES DLA MOBILE === */
@media (max-width: 768px) {
    body { font-size: 16px; }
    .container { padding: 15px 10px; }
    .controls { flex-direction: column; align-items: stretch; }
    .actions { justify-content: center; }
    .tabs { gap: 8px; justify-content: flex-start; overflow-x: auto; padding-bottom: 10px; }
    .tab { flex-shrink: 0; }
    .time-section, .auth-container { padding: 25px 20px; }
    header { padding: 30px 20px; }
}
    </style>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ff9f43">
    <!-- iOS specific meta tags for a native-like experience -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Daily Growth">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">
</head>
<body>

    <div id="auth-page">
        <div class="auth-container">
            <h1>üå± Daily Growth</h1>
            <div class="auth-toggle">
                <span id="toggleText">Nie masz konta?</span>
                <button id="toggleAuthBtn" type="button">Zarejestruj siƒô</button>
            </div>
            <form id="authForm" class="auth-form">
                <div class="auth-error" id="authError"></div>
                <input type="text" id="authLogin" placeholder="Login" autocomplete="username" required>
                <input type="password" id="authPassword" placeholder="Has≈Ço" autocomplete="current-password" required>
                <button class="btn btn-primary" id="authSubmitBtn" type="submit">Zaloguj siƒô</button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="container">
            <header>
                <h1>üå± Daily Growth 2.0</h1>
                <p class="quote" id="dailyQuote"></p>
            </header>
            <div class="controls">
                <div class="date-controls">
                    <button class="btn btn-primary" id="prev-day-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
                    </button>
                    <input type="date" id="currentDate">
                    <button class="btn btn-primary" id="next-day-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
                    </button>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" id="pdf-btn">PDF</button>
                    <button class="btn btn-primary" id="dark-mode-btn">Tryb</button>
                    <button class="btn btn-secondary" id="settings-btn">Ustawienia</button>
                    <button class="btn btn-primary" id="logout-btn">Wyloguj</button>
                </div>
            </div>
            <div class="tabs" role="tablist">
                <div class="tab active" data-section="morning">üåÖ Poranek</div>
                <div class="tab" data-section="afternoon">‚òÄÔ∏è Po≈Çudnie</div>
                <div class="tab" data-section="evening">üåô Wiecz√≥r</div>
                <div class="tab" data-section="stats">üìä Analiza trend√≥w</div>
            </div>
            <section id="morning-panel" class="section active"></section>
            <section id="afternoon-panel" class="section"></section>
            <section id="evening-panel" class="section"></section>
            <section id="stats-panel" class="section"></section>
        </div>
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header"><h3>‚öôÔ∏è Ustawienia</h3><button class="close-modal-btn">‚úñ</button></div>
                <div class="modal-tabs">
                    <div class="modal-tab active" data-section="morning">üåÖ Poranek</div>
                    <div class="modal-tab" data-section="afternoon">‚òÄÔ∏è Po≈Çudnie</div>
                    <div class="modal-tab" data-section="evening">üåô Wiecz√≥r</div>
                    <div class="modal-tab" data-section="habits">‚úÖ Nawyki</div>
                </div>
                <div id="s-morning-panel" class="modal-tab-panel active"></div>
                <div id="s-afternoon-panel" class="modal-tab-panel"></div>
                <div id="s-evening-panel" class="modal-tab-panel"></div>
                <div id="s-habits-panel" class="modal-tab-panel"></div>
                <button class="btn btn-primary" id="save-settings-btn" style="margin-top: 20px; width: 100%;">Zapisz i zamknij</button>
            </div>
        </div>
        <div class="modal" id="timeCapsuleModal">
            <div class="modal-content">
                <div class="modal-header"><h3>üï∞Ô∏è Kapsu≈Ça Czasu!</h3><button class="close-modal-btn">‚úñ</button></div>
                <p>Oto Tw√≥j wpis z tego samego dnia, dok≈Çadnie rok temu.</p>
                <div id="timeCapsuleContent"></div>
            </div>
        </div>
        <div class="notification" id="notification"></div>
    </div>

    <script>
    'use strict';

    const Auth = {
        mode: "login",
        init() {
            this.cacheDOM();
            this.bindEvents();
        },
        cacheDOM() {
            this.authPage = document.getElementById('auth-page');
            this.mainApp = document.getElementById('main-app');
            this.authForm = document.getElementById('authForm');
            this.authLogin = document.getElementById('authLogin');
            this.authPassword = document.getElementById('authPassword');
            this.authError = document.getElementById('authError');
            this.authSubmitBtn = document.getElementById('authSubmitBtn');
            this.toggleAuthBtn = document.getElementById('toggleAuthBtn');
            this.toggleText = document.getElementById('toggleText');
        },
        bindEvents() {
            this.authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (this.mode === "login") this.login();
                else this.register();
            });
            this.toggleAuthBtn.addEventListener('click', () => {
                if (this.mode === "login") this.showRegister();
                else this.showLogin();
            });
        },
        showLogin() {
            this.mode = "login";
            this.authSubmitBtn.textContent = "Zaloguj siƒô";
            this.toggleText.textContent = "Nie masz konta?";
            this.toggleAuthBtn.textContent = "Zarejestruj siƒô";
            this.authError.textContent = "";
            this.authLogin.value = "";
            this.authPassword.value = "";
        },
        showRegister() {
            this.mode = "register";
            this.authSubmitBtn.textContent = "Zarejestruj siƒô";
            this.toggleText.textContent = "Masz ju≈º konto?";
            this.toggleAuthBtn.textContent = "Zaloguj siƒô";
            this.authError.textContent = "";
            this.authLogin.value = "";
            this.authPassword.value = "";
        },
        async login() {
            const login = this.authLogin.value.trim();
            const password = this.authPassword.value;
            if (!login || !password) {
                this.authError.textContent = "Podaj login i has≈Ço.";
                return;
            }
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, password })
                });
                if (res.ok) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('dg_user', login);
                    this.showMainApp();
                } else {
                    const data = await res.json();
                    this.authError.textContent = data.message || "B≈ÇƒÖd logowania.";
                }
            } catch (e) {
                this.authError.textContent = "B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.";
            }
        },
        async register() {
            const login = this.authLogin.value.trim();
            const password = this.authPassword.value;
            if (!login || !password) {
                this.authError.textContent = "Podaj login i has≈Ço.";
                return;
            }
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, password })
                });
                if (res.ok) {
                    this.authError.textContent = "Rejestracja udana! Mo≈ºesz siƒô zalogowaƒá.";
                    setTimeout(() => this.showLogin(), 1500);
                } else {
                    const data = await res.json();
                    this.authError.textContent = data.message || "B≈ÇƒÖd rejestracji.";
                }
            } catch (e) {
                this.authError.textContent = "B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.";
            }
        },
        showMainApp() {
            this.authPage.classList.add('hidden');
            this.mainApp.classList.remove('hidden');
            initializeAppLogic();
        },
        logout() {
            sessionStorage.removeItem('isLoggedIn');
            sessionStorage.removeItem('dg_user');
            window.location.reload();
        },
        checkLoginStatus() {
            if (sessionStorage.getItem('isLoggedIn')) {
                this.showMainApp();
            } else {
                this.authPage.classList.remove('hidden');
                this.mainApp.classList.add('hidden');
            }
        }
    };

    const initialQuestions = {
        morning: [
            {id:"m1", text:"Za co jestem dzi≈õ wdziƒôczny/a?"}, {id:"m2", text:"Najwa≈ºniejszy cel na dzisiaj to‚Ä¶"}, {id:"m3", text:"Co sprawi, ≈ºe ten dzie≈Ñ bƒôdzie wyjƒÖtkowy?"}, {id:"m4", text:"JakƒÖ afirmacjƒô wybieram na dzi≈õ?"}, {id:"m5", text:"Jaki ma≈Çy krok przybli≈ºy mnie do celu?"}
        ],
        afternoon: [
            {id:"a1", text:"Co ju≈º osiƒÖgnƒÖ≈Çem/am do tej pory?"}, {id:"a2", text:"Z czego jestem dumny/a?"}, {id:"a3", text:"Jakie wyzwanie pojawi≈Ço siƒô i jak je pokona≈Çem/am?"}, {id:"a4", text:"Co mogƒô ulepszyƒá w drugiej czƒô≈õci dnia?"}
        ],
        evening: [
            {id:"e1", text:"3 najlepsze momenty dnia to‚Ä¶"}, {id:"e2", text:"Czego nauczy≈Ç mnie dzisiejszy dzie≈Ñ?"}, {id:"e3", text:"Za co sobie dzi≈õ dziƒôkujƒô?"}, {id:"e4", text:"Z jakƒÖ emocjƒÖ chcƒô zako≈Ñczyƒá dzie≈Ñ?"}
        ]
    };
    const initialHabits = ["Medytacja", "Trening", "Czytanie ksiƒÖ≈ºki"];
    const sentimentQuestions = [
        { id: 'health', question: 'üí™ Jak oceniam swoje zdrowie?' }, { id: 'finance', question: 'üí∞ Jak oceniam swoje finanse?' }, { id: 'relation', question: '‚ù§Ô∏è Jak oceniam swoje relacje?' }
    ];
    const affirmations = [
        "Jestem pewny swojej wizji i podƒÖ≈ºam za niƒÖ z odwagƒÖ i spokojem.", "Ka≈ºdego dnia tworzƒô zdrowe, wolne i kreatywne ≈ºycie na w≈Çasnych zasadach."
    ];
    const positiveKeywords = ['dobrze', 'super', '≈õwietnie', 'cudownie', 'wspaniale', 'rado≈õƒá', 'szczƒô≈õcie', 'dumny', 'dziƒôkujƒô', 'wdziƒôczny', 'uda≈Ço', 'sukces'];
    const negativeKeywords = ['≈∫le', 'fatalnie', 'smutek', 'z≈Ço≈õƒá', 'problem', 'trudno≈õƒá', 'pora≈ºka', 'nie uda≈Ço', 'zmƒôczony', 'stres', 'martwiƒô', 'gorzej'];
    const quotes = [
        "Ka≈ºdy dzie≈Ñ to nowa szansa na lepszƒÖ wersjƒô siebie. üå±", "Ma≈Çe kroki codziennie dajƒÖ ogromne rezultaty. üöÄ"
    ];
    let currentQuestions, currentHabits, currentDate, notificationTimeout, isAppInitialized = false;

    class DateHelpers {
        static subDays(date, amount) { const d = new Date(date); d.setDate(d.getDate() - amount); return d; }
        static subYears(date, amount) { const d = new Date(date); d.setFullYear(d.getFullYear() - amount); return d; }
        static formatDateISO(date) { return date.toISOString().split('T')[0]; }
    }

    class AppStorage {
        static getDayEntry(date) { const user = sessionStorage.getItem('dg_user'); try { return JSON.parse(localStorage.getItem(`dg_entry_${user}_${date}`)) || {}; } catch (e) { return {}; } }
        static saveDayEntry(date, entry) { const user = sessionStorage.getItem('dg_user'); try { localStorage.setItem(`dg_entry_${user}_${date}`, JSON.stringify(entry)); showNotification("Auto-zapisano ‚úÖ"); } catch (e) { showNotification("B≈ÇƒÖd zapisu danych."); } }
        static getSetting(key) { const user = sessionStorage.getItem('dg_user'); try { const s = JSON.parse(localStorage.getItem(`dg_settings_${user}`)) || {}; return s[key]; } catch (e) { return null; } }
        static setSetting(key, value) { const user = sessionStorage.getItem('dg_user'); let s = {}; try { s = JSON.parse(localStorage.getItem(`dg_settings_${user}`)) || {}; } catch (e) {} s[key] = value; localStorage.setItem(`dg_settings_${user}`, JSON.stringify(s)); }
        static getQuestions() { const user = sessionStorage.getItem('dg_user'); let q = JSON.parse(localStorage.getItem(`dg_questions_${user}`)); if (!q || !q.morning || !q.morning[0] || typeof q.morning[0] === 'string') { q = initialQuestions; this.saveQuestions(q); } return q; }
        static saveQuestions(q) { const user = sessionStorage.getItem('dg_user'); localStorage.setItem(`dg_questions_${user}`, JSON.stringify(q)); }
        static getHabits() { const user = sessionStorage.getItem('dg_user'); return JSON.parse(localStorage.getItem(`dg_habits_${user}`)) || initialHabits; }
        static saveHabits(h) { const user = sessionStorage.getItem('dg_user'); localStorage.setItem(`dg_habits_${user}`, JSON.stringify(h)); }
    }

    class UI {
        static buildSection(sectionId, title, emoji, containerSelector) {
            const panel = document.querySelector(containerSelector);
            if(!panel) return;
            panel.innerHTML = `<div class="time-section"><h2 class="time-header">${emoji} ${title}</h2><div id="${sectionId}-content-container"></div></div>`;
            const contentContainer = document.getElementById(`${sectionId}-content-container`);
            currentQuestions[sectionId].forEach(q => {
                const isAffirmation = sectionId === 'morning' && q.text.toLowerCase().includes('afirmacj');
                let questionHtml = `<div class="question-group"><label class="question">${q.text}</label>`;
                if (isAffirmation) { questionHtml += `<div class="affirmation-wrapper"><select data-id="${q.id}" class="affirmation-select"><option value="">Wybierz...</option>${affirmations.map(aff => `<option value="${aff}">${aff.substring(0, 60)}...</option>`).join('')}<option value="custom">Inna...</option></select><div class="hidden-textarea"><textarea data-id="${q.id}"></textarea></div></div>`; }
                else { questionHtml += `<textarea data-id="${q.id}"></textarea>`; }
                contentContainer.innerHTML += questionHtml + `</div>`;
            });
            if (sectionId === 'evening') {
                contentContainer.innerHTML += `<div class="summary-block"><div class="summary-title">Podsumowanie dnia:</div>${sentimentQuestions.map(sq => `<div class="question-group"><label class="question">${sq.question}</label><textarea data-id="${sq.id}"></textarea><div class="sentiment-buttons"><button class="btn-sent pos" data-id="${sq.id}" data-sent="pos">üòä</button><button class="btn-sent neg" data-id="${sq.id}" data-sent="neg">üòû</button></div></div>`).join('')}</div>`;
                if (currentHabits.length > 0) { contentContainer.innerHTML += `<div class="summary-block habit-tracker"><div class="summary-title">Nawyki:</div>${currentHabits.map(h => `<div class="habit-item"><label><input type="checkbox" data-habit-name="${h}"> ${h}</label></div>`).join('')}</div>`; }
            }
            contentContainer.querySelectorAll('textarea, select').forEach(el => { el.addEventListener('input', (e) => UI.saveInput(sectionId, e.target)); if (el.tagName === 'SELECT') { el.addEventListener('change', (e) => UI.handleAffirmationChange(e.target)); } });
            contentContainer.querySelectorAll('input[type="checkbox"]').forEach(el => el.addEventListener('change', (e) => UI.saveHabitStatus(e.target)));
            contentContainer.querySelectorAll('.btn-sent').forEach(btn => btn.addEventListener('click', (e) => UI.setSentiment(e.currentTarget.dataset.id, e.currentTarget.dataset.sent)));
        }
        static buildStatsSection(containerSelector) { const el = document.querySelector(containerSelector); if(el) el.innerHTML = `<div class="statistics"><div class="stats-header"><h2>üìä Analiza</h2><select id="statsPeriod"><option value="7">7 dni</option><option value="30" selected>30 dni</option><option value="90">90 dni</option></select></div><h3>Oceny</h3><div class="chart-container"><canvas id="sentimentChart"></canvas></div><h3>Sentyment</h3><div class="chart-container"><canvas id="textSentimentChart"></canvas></div></div>`; }
        static loadSectionData(date, sectionId) {
            const entry = AppStorage.getDayEntry(date), sectionData = entry[sectionId] || {};
            document.querySelectorAll(`#${sectionId}-panel textarea, #${sectionId}-panel select`).forEach(el => {
                const id = el.dataset.id;
                if (!id) return;
                if (el.classList.contains('affirmation-select')) {
                    const value = sectionData[id] || '';
                    const predefined = affirmations.find(aff => aff === value);
                    el.value = predefined ? value : (value ? 'custom' : '');
                    UI.handleAffirmationChange(el);
                    el.parentElement.querySelector('textarea').value = predefined ? '' : value;
                } else if (sentimentQuestions.some(sq => sq.id === id)) {
                     el.value = sectionData[id + 'Text'] || '';
                } else {
                    el.value = sectionData[id] || '';
                }
            });
            if (sectionId === 'evening') {
                sentimentQuestions.forEach(sq => {
                    const sentValue = sectionData[sq.id + 'Sent'];
                    document.querySelectorAll(`#evening-panel [data-id="${sq.id}"]`).forEach(el => el.classList.remove('active'));
                    if (sentValue) document.querySelector(`#evening-panel [data-id="${sq.id}"][data-sent="${sentValue}"]`)?.classList.add('active');
                });
                const savedHabits = sectionData.habits || {};
                currentHabits.forEach(h => { const checkbox = document.querySelector(`[data-habit-name="${h}"]`); if (checkbox) checkbox.checked = savedHabits[h] || false; });
            }
        }
        static saveInput(sectionId, target) {
            const id = target.dataset.id, entry = AppStorage.getDayEntry(currentDate);
            if (!entry[sectionId]) entry[sectionId] = {};
            if (target.classList.contains('affirmation-select')) {
                if (target.value === 'custom') { entry[sectionId][id] = target.parentElement.querySelector('textarea').value; }
                else { entry[sectionId][id] = target.value; }
            } else if(target.parentElement.classList.contains('hidden-textarea')) {
                const select = target.parentElement.parentElement.querySelector('select');
                if(select.value === 'custom') entry[sectionId][id] = target.value;
            } else {
                const q = currentQuestions[sectionId]?.find(q => q.id === id);
                const s = sentimentQuestions.find(s => s.id === id);
                if (q) entry[sectionId][id] = target.value;
                if (s) entry[sectionId][id + 'Text'] = target.value;
            }
            AppStorage.saveDayEntry(currentDate, entry);
        }
        static saveHabitStatus(checkbox) { const habitName = checkbox.dataset.habitName, entry = AppStorage.getDayEntry(currentDate); if (!entry.evening) entry.evening = {}; if (!entry.evening.habits) entry.evening.habits = {}; entry.evening.habits[habitName] = checkbox.checked; AppStorage.saveDayEntry(currentDate, entry); }
        static handleAffirmationChange(select) { const wrapper = select.parentElement.querySelector('.hidden-textarea'); if (select.value === 'custom') wrapper.classList.add('visible'); else wrapper.classList.remove('visible'); }
        static setSentiment(catId, sent) {
            const entry = AppStorage.getDayEntry(currentDate);
            if (!entry.evening) entry.evening = {};
            entry.evening[catId + 'Sent'] = sent;
            AppStorage.saveDayEntry(currentDate, entry);
            document.querySelectorAll(`#evening-panel [data-id="${catId}"]`).forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#evening-panel [data-id="${catId}"][data-sent="${sent}"]`).classList.add('active');
            if (document.getElementById('stats-panel').classList.contains('active')) Stats.updateCharts();
        }
    }

    class Stats {
        static sentimentChart = null; static textSentimentChart = null;
        static getChartColors() { const isDark = document.documentElement.classList.contains('dark-mode'); return { textColor: isDark ? '#e0e0e0' : '#373737', gridColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)', posColor: '#4ade80', posBgColor: 'rgba(74,222,128,0.2)', negColor: '#ff5e5e', negBgColor: 'rgba(255,94,94,0.2)', pointColor: '#ff9f43' }; }
        static initCharts() {
            if(Stats.sentimentChart) Stats.sentimentChart.destroy(); if(Stats.textSentimentChart) Stats.textSentimentChart.destroy();
            const commonOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' }, title: { display: true, text: 'Data' } }, y: { beginAtZero: true, max: 100, ticks: { callback: (v) => `${v}%` } } }, plugins: { legend: { display: true }, tooltip: { callbacks: { title: (ctx) => new Date(ctx[0].label).toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' }) } } }};
            const sentimentChartEl = document.getElementById('sentimentChart');
            const textSentimentChartEl = document.getElementById('textSentimentChart');
            if (sentimentChartEl) Stats.sentimentChart = new Chart(sentimentChartEl, { type: 'line', data: { datasets: [{ label: 'Pozytywne oceny', tension: 0.4, fill: true }] }, options: { ...commonOptions, plugins: { ...commonOptions.plugins, tooltip: { ...commonOptions.plugins.tooltip, callbacks: { ...commonOptions.plugins.tooltip.callbacks, label: (ctx) => `Pozytywnych: ${ctx.raw.toFixed(1)}%` } } }, scales: {...commonOptions.scales, y: {...commonOptions.scales.y, title: {display: true, text: '% pozytywnych ocen'}}}}});
            if (textSentimentChartEl) Stats.textSentimentChart = new Chart(textSentimentChartEl, { type: 'bar', data: { datasets: [{ label: 'Sentyment tekstu' }] }, options: { ...commonOptions, scales: {...commonOptions.scales, y: {...commonOptions.scales.y, title: {display: true, text: 'Wynik sentymentu'}}}}});
            this.updateChartStyles();
        }
        static updateCharts() {
            const periodEl = document.getElementById('statsPeriod');
            if (!periodEl || !Stats.sentimentChart || !Stats.textSentimentChart) return;
            const period = periodEl.value;
            const days = parseInt(period, 10);
            const sentimentTrend = Stats.getDailySentimentTrend(days), textSentimentTrend = Stats.getTextSentimentTrend(days);
            Stats.sentimentChart.data.labels = sentimentTrend.labels; Stats.sentimentChart.data.datasets[0].data = sentimentTrend.data; Stats.sentimentChart.update();
            Stats.textSentimentChart.data.labels = textSentimentTrend.labels; Stats.textSentimentChart.data.datasets[0].data = textSentimentTrend.data; const colors = Stats.getChartColors(); Stats.textSentimentChart.data.datasets[0].backgroundColor = textSentimentTrend.data.map(d => d >= 50 ? colors.posBgColor : colors.negBgColor); Stats.textSentimentChart.data.datasets[0].borderColor = textSentimentTrend.data.map(d => d >= 50 ? colors.posColor : colors.negColor); Stats.textSentimentChart.data.datasets[0].borderWidth = 1; Stats.textSentimentChart.update();
        }
        static updateChartStyles() { const c = Stats.getChartColors(); [Stats.sentimentChart, Stats.textSentimentChart].forEach(chart => { if (!chart) return; const o = chart.options; o.plugins.legend.labels.color = c.textColor; ['x', 'y'].forEach(a => { o.scales[a].title.color = c.textColor; o.scales[a].ticks.color = c.textColor; o.scales[a].grid.color = c.gridColor; }); }); if (Stats.sentimentChart) { const ds1 = Stats.sentimentChart.data.datasets[0]; ds1.borderColor = c.posColor; ds1.backgroundColor = c.posBgColor; ds1.pointBackgroundColor = c.pointColor; Stats.sentimentChart.update(); } if (Stats.textSentimentChart) { Stats.textSentimentChart.update(); } }
        static getDailySentimentTrend(days) { const l = [], d = [], t = new Date(); for (let i = days - 1; i >= 0; i--) { const dateObj = DateHelpers.subDays(t, i), dateStr = DateHelpers.formatDateISO(dateObj); l.push(dateStr); const e = AppStorage.getDayEntry(dateStr).evening || {}; let p = 0, tt = 0; sentimentQuestions.forEach(sq => { const sent = e[sq.id + 'Sent']; if (sent) { tt++; if (sent === 'pos') p++; } }); d.push(tt > 0 ? (p / tt) * 100 : NaN); } return { labels: l, data: d }; }
        static getTextSentimentTrend(days) { const l = [], d = [], t = new Date(); for (let i = days - 1; i >= 0; i--) { const dateObj = DateHelpers.subDays(t, i), dateStr = DateHelpers.formatDateISO(dateObj); l.push(dateStr); d.push(Stats.calculateTextSentiment(AppStorage.getDayEntry(dateStr))); } return { labels: l, data: d }; }
        static calculateTextSentiment(entry) { let text = ''; ['morning', 'afternoon', 'evening'].forEach(s => { if (entry[s]) Object.keys(entry[s]).forEach(key => { if (typeof entry[s][key] === 'string') text += entry[s][key] + ' '; }); }); if (text.trim() === '') return NaN; const words = text.toLowerCase().match(/\b(\w+)\b/g) || []; if(words.length === 0) return NaN; let score = 0; words.forEach(word => { if (positiveKeywords.includes(word)) score++; if (negativeKeywords.includes(word)) score--; }); return Math.max(0, Math.min(100, 50 + (score / words.length) * 250)); }
    }

    class Settings {
        static tempQuestions; static tempHabits; static originalQuestions; static originalHabits; static isEditing = { morning: false, afternoon: false, evening: false, habits: false };
        static init() { document.getElementById('save-settings-btn').addEventListener('click', () => this.saveAndClose()); document.querySelectorAll('#settingsModal .modal-tab').forEach(tab => tab.addEventListener('click', (e) => this.switchTab(e.target))); }
        static open() { this.originalQuestions = AppStorage.getQuestions(); this.originalHabits = AppStorage.getHabits(); this.tempQuestions = JSON.parse(JSON.stringify(this.originalQuestions)); this.tempHabits = [...this.originalHabits]; Object.keys(this.isEditing).forEach(key => this.isEditing[key] = false); this.switchTab(document.querySelector('#settingsModal .modal-tab.active')); openModal('settingsModal'); }
        static switchTab(tabEl) { document.querySelectorAll('#settingsModal .modal-tab, #settingsModal .modal-tab-panel').forEach(el => el.classList.remove('active')); tabEl.classList.add('active'); const sectionId = tabEl.dataset.section; document.getElementById(`s-${sectionId}-panel`).classList.add('active'); this.render(sectionId); }
        static render(sectionId) {
            const container = document.getElementById(`s-${sectionId}-panel`); const isQuestion = sectionId !== 'habits'; const items = isQuestion ? this.tempQuestions[sectionId] : this.tempHabits;
            let listHtml = '<ul class="management-list">';
            if (this.isEditing[sectionId]) { items.forEach((item, index) => { const text = isQuestion ? item.text : item; listHtml += `<li class="management-item"><input type="text" value="${text.replace(/"/g, '&quot;')}" data-index="${index}"><button class="action-btn delete-btn" data-index="${index}">üóëÔ∏è</button></li>`; }); }
            else { items.forEach(item => { const text = isQuestion ? item.text : item; listHtml += `<li class="management-item"><span>${text}</span></li>`; }); }
            listHtml += '</ul>';
            let buttonsHtml = '<div class="edit-controls">';
            if (this.isEditing[sectionId]) { buttonsHtml += `<button class="btn btn-primary" id="save-list-btn">‚úÖ Zapisz</button><button class="btn btn-secondary" id="cancel-list-btn">‚ùå Anuluj</button><button class="btn btn-primary" id="add-item-btn">‚ûï Dodaj</button>`; }
            else { buttonsHtml += `<button class="btn btn-primary" id="edit-list-btn">‚úçÔ∏è Edytuj listƒô</button>`; }
            buttonsHtml += '</div>';
            container.innerHTML = listHtml + buttonsHtml;
            if (this.isEditing[sectionId]) {
                container.querySelector('#save-list-btn').addEventListener('click', () => this.saveList(sectionId));
                container.querySelector('#cancel-list-btn').addEventListener('click', () => this.cancelEdit(sectionId));
                container.querySelector('#add-item-btn').addEventListener('click', () => this.addItem(sectionId));
                container.querySelectorAll('input[type="text"]').forEach(input => input.addEventListener('input', (e) => this.updateTempItem(e.target, sectionId)));
                container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => this.deleteItem(sectionId, e.currentTarget.dataset.index)));
            } else {
                container.querySelector('#edit-list-btn').addEventListener('click', () => this.toggleEditMode(sectionId));
            }
        }
        static toggleEditMode(sectionId) { this.isEditing[sectionId] = true; this.render(sectionId); }
        static cancelEdit(sectionId) { if (sectionId === 'habits') { this.tempHabits = [...this.originalHabits]; } else { this.tempQuestions[sectionId] = JSON.parse(JSON.stringify(this.originalQuestions[sectionId])); } this.isEditing[sectionId] = false; this.render(sectionId); }
        static saveList(sectionId) { this.isEditing[sectionId] = false; this.render(sectionId); }
        static updateTempItem(input, sectionId) { const index = input.dataset.index, value = input.value; if (sectionId === 'habits') { this.tempHabits[index] = value; } else { this.tempQuestions[sectionId][index].text = value; } }
        static deleteItem(sectionId, index) { if (sectionId === 'habits') { this.tempHabits.splice(index, 1); } else { this.tempQuestions[sectionId].splice(index, 1); } this.render(sectionId); }
        static addItem(sectionId) { if (sectionId === 'habits') { this.tempHabits.push("Nowy nawyk"); } else { this.tempQuestions[sectionId].push({ id: `q_${Date.now()}`, text: "Nowe pytanie" }); } this.render(sectionId); }
        static saveAndClose() { AppStorage.saveQuestions(this.tempQuestions); AppStorage.saveHabits(this.tempHabits); currentQuestions = AppStorage.getQuestions(); currentHabits = AppStorage.getHabits(); rebuildAllSections(); loadDate(); closeModal('settingsModal'); showNotification("Ustawienia zapisane! ‚úÖ"); }
    }

    function initializeAppLogic() {
        if (isAppInitialized) return;
        currentQuestions = AppStorage.getQuestions();
        currentHabits = AppStorage.getHabits();
        currentDate = DateHelpers.formatDateISO(new Date());
        document.getElementById('dailyQuote').textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
        bindAppEventListeners();
        rebuildAllSections();
        UI.buildStatsSection('#stats-panel');
        loadDate();
        Stats.initCharts();
        if (AppStorage.getSetting('darkMode')) document.documentElement.classList.add('dark-mode');
        isAppInitialized = true;
    }

    function bindAppEventListeners() {
        document.getElementById('prev-day-btn').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-day-btn').addEventListener('click', () => changeDate(1));
        document.getElementById('currentDate').addEventListener('change', loadDate);
        document.getElementById('pdf-btn').addEventListener('click', exportPDF);
        document.getElementById('dark-mode-btn').addEventListener('click', toggleDarkMode);
        document.getElementById('settings-btn').addEventListener('click', () => Settings.open());
        document.getElementById('logout-btn').addEventListener('click', () => Auth.logout());
        const statsPeriodEl = document.getElementById('statsPeriod');
        if (statsPeriodEl) statsPeriodEl.addEventListener('change', () => Stats.updateCharts());
        document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', (e) => {
            document.querySelectorAll('.tab, .section').forEach(el => el.classList.remove('active'));
            e.target.classList.add('active');
            const sId = e.target.dataset.section;
            document.getElementById(`${sId}-panel`).classList.add('active');
            if (sId === 'stats') Stats.updateCharts();
        }));
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal').id)));
        Settings.init();
    }

    function rebuildAllSections() { UI.buildSection('morning', 'Poranek', 'üåÖ', '#morning-panel'); UI.buildSection('afternoon', 'Po≈Çudnie', '‚òÄÔ∏è', '#afternoon-panel'); UI.buildSection('evening', 'Wiecz√≥r', 'üåô', '#evening-panel'); }
    function loadDate() { document.getElementById('currentDate').value = currentDate; ['morning', 'afternoon', 'evening'].forEach(s => UI.loadSectionData(currentDate, s)); if (document.getElementById('stats-panel').classList.contains('active')) Stats.updateCharts(); }
    function changeDate(d) { const dt = new Date(currentDate); dt.setDate(dt.getDate() + d); currentDate = DateHelpers.formatDateISO(dt); loadDate(); }
    function toggleDarkMode() { document.documentElement.classList.toggle('dark-mode'); AppStorage.setSetting('darkMode', document.documentElement.classList.contains('dark-mode')); Stats.updateChartStyles(); }
    function showNotification(m, d = 3000) { const el = document.getElementById('notification'); clearTimeout(notificationTimeout); el.textContent = m; el.classList.add('active'); notificationTimeout = setTimeout(() => el.classList.remove('active'), d - 100); }
    function openModal(id) { document.getElementById(id)?.classList.add('active'); }
    function closeModal(id) { document.getElementById(id)?.classList.remove('active'); }
    function exportPDF() { showNotification("Funkcja eksportu PDF w budowie."); }

    document.addEventListener('DOMContentLoaded', () => {
        Auth.init();
        Auth.checkLoginStatus();
        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker zarejestrowany pomy≈õlnie:', registration);
                })
                .catch(error => {
                    console.log('Rejestracja Service Workera nie powiod≈Ça siƒô:', error);
                });
        });
    }
});
    </script>
</body>
</html>