<!DOCTYPE html>
<html lang="pl" data-theme="fokus">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Centrum CelÃ³w ðŸŒ± â€“ OsiÄ…gaj z Brianem Tracy</title>
  <meta name="description" content="Aplikacja do wyznaczania i realizacji celÃ³w oparta na metodologii Briana Tracy'ego.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400..700;1,400..1000&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap&subset=latin-ext" rel="stylesheet">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¯</text></svg>">
  <meta name="theme-color" content="#27272A">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Centrum CelÃ³w">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>

  <style>
    :root{--font-primary:'Inter',sans-serif;--font-secondary:'Lora',serif;--font-ui:'Nunito',sans-serif;--ease-in-out:cubic-bezier(0.4,0,0.2,1);--transition-fast:200ms var(--ease-in-out);--transition-medium:300ms var(--ease-in-out)}[data-theme="fokus"]{--bg-primary:#18181B;--bg-secondary:#27272A;--bg-tertiary:#3F3F46;--text-primary:#F4F4F5;--text-secondary:#A1A1AA;--text-tertiary:#71717A;--accent-primary:#FBBF24;--accent-secondary:#34D399;--accent-info:#60A5FA;--border-primary:#3F3F46;--shadow-color:rgba(0,0,0,0.2)}[data-theme="jasny"]{--bg-primary:#F9FAFB;--bg-secondary:#FFFFFF;--bg-tertiary:#F3F4F6;--text-primary:#111827;--text-secondary:#6B7280;--text-tertiary:#9CA3AF;--accent-primary:#3B82F6;--accent-secondary:#10B981;--accent-info:#6366F1;--border-primary:#E5E7EB;--shadow-color:rgba(0,0,0,0.05)}[data-theme="ciemny"]{--bg-primary:#111827;--bg-secondary:#1F2937;--bg-tertiary:#374151;--text-primary:#F9FAFB;--text-secondary:#9CA3AF;--text-tertiary:#6B7280;--accent-primary:#60A5FA;--accent-secondary:#34D399;--accent-info:#818CF8;--border-primary:#374151;--shadow-color:rgba(0,0,0,0.25)}[data-theme="las"]{--bg-primary:#F0FDF4;--bg-secondary:#FFFFFF;--bg-tertiary:#DCFCE7;--text-primary:#14532D;--text-secondary:#166534;--text-tertiary:#15803D;--accent-primary:#22C55E;--accent-secondary:#84CC16;--accent-info:#3B82F6;--border-primary:#BBF7D0;--shadow-color:rgba(20,83,45,0.07)}[data-theme="ocean"]{--bg-primary:#F0F9FF;--bg-secondary:#FFFFFF;--bg-tertiary:#E0F2FE;--text-primary:#0C4A6E;--text-secondary:#0369A1;--text-tertiary:#075985;--accent-primary:#38BDF8;--accent-secondary:#2DD4BF;--accent-info:#3B82F6;--border-primary:#BAE6FD;--shadow-color:rgba(12,74,110,0.07)}[data-theme="blask"]{--bg-primary:#FFFBEB;--bg-secondary:#FFFFFF;--bg-tertiary:#FEF3C7;--text-primary:#78350F;--text-secondary:#9A3412;--text-tertiary:#B45309;--accent-primary:#F59E0B;--accent-secondary:#F97316;--accent-info:#3B82F6;--border-primary:#FDE68A;--shadow-color:rgba(120,53,15,0.07)}*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}body{background-color:var(--bg-primary);color:var(--text-primary);font-family:var(--font-ui);-webkit-font-smoothing:antialiased;line-height:1.6;overscroll-behavior:none;min-height:100vh;transition:background-color var(--transition-medium),color var(--transition-medium)}#main-app{display:flex;flex-direction:column;min-height:100vh}.container{max-width:800px;width:100%;margin:0 auto;padding:1.5rem 1rem;display:flex;flex-direction:column;flex-grow:1}header{text-align:center;margin-bottom:1.5rem;flex-shrink:0}header h1{font-family:var(--font-secondary);font-size:2.5rem;font-weight:700;line-height:1.2}.header-subtitle{font-size:1rem;color:var(--text-secondary);margin-top:0.25rem}.quote{font-family:var(--font-secondary);font-style:italic;font-size:.9rem;color:var(--text-tertiary);margin-top:1rem;padding:0 1rem;max-width:600px;margin-left:auto;margin-right:auto}.controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;flex-shrink:0}.date-controls,.theme-controls{display:flex;align-items:center;gap:.5rem}.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;font-family:var(--font-ui);font-weight:600;padding:.5rem 1rem;border:1px solid transparent;border-radius:8px;cursor:pointer;text-decoration:none;transition:background-color var(--transition-fast),color var(--transition-fast),border-color var(--transition-fast),transform var(--transition-fast);white-space:nowrap}.btn:hover{transform:translateY(-2px)}.btn:focus-visible{outline:2px solid var(--accent-info);outline-offset:2px}.btn-primary{background-color:var(--accent-primary);color:var(--bg-primary)}.btn-primary:hover{filter:brightness(1.1)}.btn-secondary{background-color:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-primary)}.btn-secondary:hover{background-color:var(--bg-tertiary)}.btn-icon{padding:.5rem;background-color:var(--bg-secondary);border:1px solid var(--border-primary);color:var(--text-secondary)}.btn-icon:hover{background-color:var(--bg-tertiary);color:var(--text-primary)}input,select,textarea{background:var(--bg-secondary);border:1px solid var(--border-primary);border-radius:8px;padding:.5rem .75rem;font-family:var(--font-ui);color:var(--text-primary);transition:border-color var(--transition-fast),box-shadow var(--transition-fast);width:100%}.form-group textarea{min-height:100px;resize:vertical}input:focus,select:focus,textarea:focus{border-color:var(--accent-primary);box-shadow:0 0 0 2px var(--accent-primary);outline:none}.daily-entry{background-color:var(--bg-secondary);border:1px solid var(--border-primary);border-radius:12px;padding:1.25rem;margin-bottom:1.5rem;box-shadow:0 4px 6px -1px var(--shadow-color)}.daily-entry h2{font-family:var(--font-secondary);font-size:1.3rem;margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between}.save-status{font-size:.8rem;color:var(--text-tertiary);opacity:0;transition:opacity var(--transition-fast)}.save-status.is-visible{opacity:1}.goals-list{display:flex;flex-direction:column;gap:1rem}.goal-card{background-color:var(--bg-secondary);border-radius:12px;border:1px solid var(--border-primary);box-shadow:0 4px 6px -1px var(--shadow-color);transition:transform var(--transition-fast),box-shadow var(--transition-fast)}.goal-card:hover{transform:translateY(-2px);box-shadow:0 10px 15px -3px var(--shadow-color)}.goal-header{width:100%;background:none;border:none;padding:1.25rem;display:flex;align-items:center;gap:1rem;text-align:left;cursor:pointer;border-radius:12px}.goal-header:focus-visible{outline:2px solid var(--accent-info);outline-offset:2px}.goal-content{flex-grow:1}.goal-title{font-size:1.1rem;font-weight:600;font-family:var(--font-primary);color:var(--text-primary)}.goal-details{font-size:.9rem;color:var(--text-secondary)}.goal-actions{display:flex;gap:.5rem;margin-left:auto}.goal-plan{display:grid;grid-template-rows:0fr;transition:grid-template-rows var(--transition-medium)}.goal-plan-content{overflow:hidden}.goal-card[aria-expanded="true"] .goal-plan{grid-template-rows:1fr}.steps-list{list-style:none;padding:0 1.25rem 1.25rem;display:flex;flex-direction:column;gap:.75rem;border-top:1px solid var(--border-primary);margin:0 1.25rem}.step-item{display:flex;align-items:center;gap:.75rem}.step-item label{color:var(--text-primary);cursor:pointer}.step-item input[type="checkbox"]:checked+label{text-decoration:line-through;color:var(--text-tertiary)}.step-checkbox{flex-shrink:0;width:20px;height:20px;border:2px solid var(--border-primary);border-radius:4px;cursor:pointer}.modal-overlay{position:fixed;inset:0;background-color:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:opacity var(--transition-medium),visibility var(--transition-medium);z-index:1000}.modal-overlay.is-visible{opacity:1;visibility:visible}.modal-content{background-color:var(--bg-secondary);border-radius:12px;padding:2rem;width:90%;max-width:500px;box-shadow:0 10px 25px -5px var(--shadow-color);transform:scale(.95);transition:transform var(--transition-medium)}.modal-overlay.is-visible .modal-content{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}.modal-title{font-family:var(--font-secondary);font-size:1.5rem;font-weight:600}.form-group{margin-bottom:1rem}.form-group label{display:block;font-weight:600;margin-bottom:.5rem;font-size:.9rem}.modal-actions{display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.5rem}.delete-action{margin-right:auto}footer{text-align:center;padding:1.5rem 1rem;margin-top:2rem;font-size:.9rem;color:var(--text-tertiary);border-top:1px solid var(--border-primary);flex-shrink:0}
  </style>
</head>
<body>

  <div id="main-app">
    <div class="container">
      <header>
        <h1>Centrum CelÃ³w ðŸŒ±</h1>
        <p class="header-subtitle">Metodologia Briana Tracy'ego w Twoim zasiÄ™gu</p>
        <p class="quote">"Kluczem do sukcesu jest skupienie umysÅ‚u na tym, czego pragniemy, a nie na tym, czego siÄ™ obawiamy."</p>
      </header>

      <div class="controls">
        <div class="date-controls">
          <button id="prev-day" class="btn btn-icon" aria-label="Poprzedni dzieÅ„"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg></button>
          <input type="date" id="current-date">
          <button id="next-day" class="btn btn-icon" aria-label="NastÄ™pny dzieÅ„"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></button>
        </div>
        <div class="theme-controls">
          <select id="theme-switcher" aria-label="Wybierz motyw">
            <option value="fokus">Fokus</option><option value="jasny">Jasny</option><option value="ciemny">Ciemny</option><option value="las">Las</option><option value="ocean">Ocean</option><option value="blask">Blask</option>
          </select>
          <button id="add-goal-btn" class="btn btn-primary"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>Nowy cel</button>
        </div>
      </div>

      <main>
        <div class="daily-entry">
          <h2>RytuaÅ‚ Dzienny <span class="save-status" id="ritual-save-status">âœ“ Zapisano</span></h2>
          <div class="form-group">
            <textarea id="daily-ritual-textarea" placeholder="Wpisz swoje poranne lub wieczorne rytuaÅ‚y..."></textarea>
          </div>
        </div>

        <h2 style="font-family: var(--font-secondary); margin-bottom: 1rem; font-size: 1.3rem;">Cele na ten dzieÅ„</h2>
        <div class="goals-list" id="goals-list">
          </div>

        <div class="daily-entry" style="margin-top: 2rem;">
            <h2>Podsumowanie Dnia <span class="save-status" id="summary-save-status">âœ“ Zapisano</span></h2>
            <div class="form-group">
                <textarea id="daily-summary-textarea" placeholder="Co dziÅ› poszÅ‚o dobrze? Czego siÄ™ nauczyÅ‚eÅ›/aÅ›?"></textarea>
            </div>
        </div>
      </main>
    </div>
    
    <footer>
      <p>&copy; 2025 Centrum CelÃ³w. Stworzone z inspiracji naukami Briana Tracy'ego.</p>
    </footer>
  </div>

  <div class="modal-overlay" id="goal-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Nowy cel</h2>
        <button class="btn btn-icon" id="close-modal-btn" aria-label="Zamknij"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
      </div>
      <form id="goal-form">
        <input type="hidden" id="goal-id-input">
        <div class="form-group">
          <label for="goal-title-input">Nazwa celu</label>
          <input type="text" id="goal-title-input" placeholder="Np. UkoÅ„czyÄ‡ waÅ¼ny projekt" required>
        </div>
        <div class="form-group">
          <label for="goal-details-input">SzczegÃ³Å‚y (opcjonalne)</label>
          <input type="text" id="goal-details-input" placeholder="Np. Cel biznesowy â€¢ Wysoki priorytet">
        </div>
        <div class="form-group">
            <label for="goal-steps-input">Kroki do wykonania (kaÅ¼dy w nowej linii)</label>
            <textarea id="goal-steps-input" placeholder="1. ZdefiniowaÄ‡ wymagania&#10;2. StworzyÄ‡ harmonogram&#10;3. ZaimplementowaÄ‡ funkcjÄ™ X"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary delete-action" id="delete-goal-btn" style="color: #F87171; display: none;">UsuÅ„ cel</button>
          <button type="button" class="btn btn-secondary" id="cancel-modal-btn">Anuluj</button>
          <button type="submit" class="btn btn-primary">Zapisz</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            state: {
                currentDate: new Date(),
                goals: [],
                dailyEntries: {},
                activityLog: { ritual: [], summary: [] },
                lastFocusedElement: null,
            },
            
            init() {
                this.loadState();
                this.initDateControls();
                this.initThemeSwitcher();
                this.initModal();
                this.initEventListeners();
                this.renderAll();
            },

            loadState() {
                try {
                    const savedGoals = localStorage.getItem('goals');
                    const savedEntries = localStorage.getItem('dailyEntries');
                    const savedActivity = localStorage.getItem('activityLog');

                    this.state.goals = savedGoals ? JSON.parse(savedGoals) : [];
                    this.state.dailyEntries = savedEntries ? JSON.parse(savedEntries) : {};
                    this.state.activityLog = savedActivity ? JSON.parse(savedActivity) : { ritual: [], summary: [] };
                } catch (e) {
                    console.error("Failed to load state from localStorage", e);
                    // Optionally, show a user-facing error message
                }
            },

            saveState() {
                try {
                    localStorage.setItem('goals', JSON.stringify(this.state.goals));
                    localStorage.setItem('dailyEntries', JSON.stringify(this.state.dailyEntries));
                    localStorage.setItem('activityLog', JSON.stringify(this.state.activityLog));
                } catch (e) {
                    console.error("Failed to save state to localStorage", e);
                    alert("WystÄ…piÅ‚ bÅ‚Ä…d podczas zapisywania danych. MoÅ¼liwe, Å¼e pamiÄ™Ä‡ przeglÄ…darki jest peÅ‚na.");
                }
            },
            
            getDateKey(date) {
                return date.toISOString().split('T')[0];
            },

            initDateControls() {
                const dateInput = document.getElementById('current-date');
                const prevDayBtn = document.getElementById('prev-day');
                const nextDayBtn = document.getElementById('next-day');

                const updateDate = () => {
                    dateInput.value = this.getDateKey(this.state.currentDate);
                    this.renderAll();
                };

                prevDayBtn.addEventListener('click', () => {
                    this.state.currentDate.setDate(this.state.currentDate.getDate() - 1);
                    updateDate();
                });
                nextDayBtn.addEventListener('click', () => {
                    this.state.currentDate.setDate(this.state.currentDate.getDate() + 1);
                    updateDate();
                });
                dateInput.addEventListener('change', () => {
                    const selectedDate = new Date(dateInput.value);
                    this.state.currentDate = new Date(selectedDate.getTime() + selectedDate.getTimezoneOffset() * 60000);
                    updateDate();
                });
                dateInput.value = this.getDateKey(this.state.currentDate);
            },

            initThemeSwitcher() {
                const themeSwitcher = document.getElementById('theme-switcher');
                const htmlElement = document.documentElement;
                const savedTheme = localStorage.getItem('theme') || 'fokus';
                
                htmlElement.setAttribute('data-theme', savedTheme);
                themeSwitcher.value = savedTheme;

                themeSwitcher.addEventListener('change', (e) => {
                    const newTheme = e.target.value;
                    htmlElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                });
            },

            debounce(func, delay = 800) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            },

            showSaveStatus(elementId) {
                const statusEl = document.getElementById(elementId);
                if (!statusEl) return;
                statusEl.classList.add('is-visible');
                setTimeout(() => statusEl.classList.remove('is-visible'), 2000);
            },

            initModal() {
                const modal = document.getElementById('goal-modal');
                const openBtn = document.getElementById('add-goal-btn');
                const closeBtn = document.getElementById('close-modal-btn');
                const cancelBtn = document.getElementById('cancel-modal-btn');
                const form = document.getElementById('goal-form');
                const deleteBtn = document.getElementById('delete-goal-btn');
                const modalTitle = document.getElementById('modal-title');

                const openModal = () => {
                    this.state.lastFocusedElement = document.activeElement;
                    modal.classList.add('is-visible');
                    document.getElementById('goal-title-input').focus();
                };
                const closeModal = () => {
                    modal.classList.remove('is-visible');
                    if (this.state.lastFocusedElement) this.state.lastFocusedElement.focus();
                };
                
                openBtn.addEventListener('click', () => {
                    form.reset();
                    document.getElementById('goal-id-input').value = '';
                    modalTitle.textContent = 'Nowy cel';
                    deleteBtn.style.display = 'none';
                    openModal();
                });

                closeBtn.addEventListener('click', closeModal);
                cancelBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', e => e.target === modal && closeModal());
                
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveGoal();
                    closeModal();
                });

                deleteBtn.addEventListener('click', () => {
                    if (confirm('Czy na pewno chcesz usunÄ…Ä‡ ten cel?')) {
                        this.deleteGoal();
                        closeModal();
                    }
                });
                
                modal.addEventListener('keydown', e => {
                    if (e.key === 'Escape') closeModal();
                    if (e.key === 'Tab') {
                        const focusableElements = Array.from(modal.querySelectorAll('button, [href], input, select, textarea')).filter(el => !el.disabled);
                        const firstElement = focusableElements[0];
                        const lastElement = focusableElements[focusableElements.length - 1];

                        if (e.shiftKey) {
                            if (document.activeElement === firstElement) {
                                lastElement.focus();
                                e.preventDefault();
                            }
                        } else {
                            if (document.activeElement === lastElement) {
                                firstElement.focus();
                                e.preventDefault();
                            }
                        }
                    }
                });
            },

            saveGoal() {
                const id = document.getElementById('goal-id-input').value;
                const title = document.getElementById('goal-title-input').value.trim();
                if (!title) return; 

                const details = document.getElementById('goal-details-input').value.trim();
                const stepsText = document.getElementById('goal-steps-input').value;
                const newStepTexts = stepsText.split('\n').map(t => t.trim()).filter(t => t !== '');

                if (id) { // Editing existing goal
                    const goalIndex = this.state.goals.findIndex(g => g.id === id);
                    if (goalIndex > -1) {
                        const originalGoal = this.state.goals[goalIndex];
                        
                        const updatedSteps = newStepTexts.map(text => {
                            const existingStep = originalGoal.steps.find(s => s.text === text);
                            return existingStep ? { ...existingStep } : {
                                id: `step-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                                text: text,
                                completed: false
                            };
                        });
                        
                        originalGoal.title = title;
                        originalGoal.details = details;
                        originalGoal.steps = updatedSteps;
                    }
                } else { // New goal
                    const newGoal = {
                        id: `goal-${Date.now()}`,
                        title,
                        details,
                        steps: newStepTexts.map(text => ({
                            id: `step-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            text,
                            completed: false
                        })),
                        createdAt: this.getDateKey(this.state.currentDate)
                    };
                    this.state.goals.push(newGoal);
                }
                this.saveState();
                this.renderGoals();
            },

            deleteGoal() {
                const id = document.getElementById('goal-id-input').value;
                this.state.goals = this.state.goals.filter(g => g.id !== id);
                this.saveState();
                this.renderGoals();
            },

            openGoalForEdit(goalId) {
                const goal = this.state.goals.find(g => g.id === goalId);
                if (!goal) return;

                const modal = document.getElementById('goal-modal');
                
                document.getElementById('modal-title').textContent = 'Edytuj cel';
                document.getElementById('goal-id-input').value = goal.id;
                document.getElementById('goal-title-input').value = goal.title;
                document.getElementById('goal-details-input').value = goal.details;
                document.getElementById('goal-steps-input').value = goal.steps.map(s => s.text).join('\n');
                document.getElementById('delete-goal-btn').style.display = 'block';

                this.state.lastFocusedElement = document.activeElement;
                modal.classList.add('is-visible');
                document.getElementById('goal-title-input').focus();
            },
            
            initEventListeners() {
                const goalsList = document.getElementById('goals-list');
                const ritualTextarea = document.getElementById('daily-ritual-textarea');
                const summaryTextarea = document.getElementById('daily-summary-textarea');
                
                const debouncedSaveRitual = this.debounce((value, dateKey) => {
                    if (!this.state.dailyEntries[dateKey]) this.state.dailyEntries[dateKey] = {};
                    this.state.dailyEntries[dateKey].ritual = value;
                    this.logActivity(dateKey, 'ritual');
                    this.saveState();
                    this.showSaveStatus('ritual-save-status');
                });
                
                const debouncedSaveSummary = this.debounce((value, dateKey) => {
                    if (!this.state.dailyEntries[dateKey]) this.state.dailyEntries[dateKey] = {};
                    this.state.dailyEntries[dateKey].summary = value;
                    this.logActivity(dateKey, 'summary');
                    this.saveState();
                    this.showSaveStatus('summary-save-status');
                });

                ritualTextarea.addEventListener('input', () => debouncedSaveRitual(ritualTextarea.value, this.getDateKey(this.state.currentDate)));
                summaryTextarea.addEventListener('input', () => debouncedSaveSummary(summaryTextarea.value, this.getDateKey(this.state.currentDate)));

                goalsList.addEventListener('click', e => {
                    const header = e.target.closest('.goal-header');
                    const editBtn = e.target.closest('.edit-goal-btn');
                    
                    if (e.target.matches('.step-checkbox')) {
                       const stepCheckbox = e.target;
                       const goalId = stepCheckbox.dataset.goalId;
                       const stepId = stepCheckbox.dataset.stepId;
                       const goal = this.state.goals.find(g => g.id === goalId);
                       const step = goal?.steps.find(s => s.id === stepId);
                       if (step) {
                           step.completed = stepCheckbox.checked;
                           this.saveState();
                       }
                       return;
                    }
                    if (header) {
                        const card = header.closest('.goal-card');
                        const isExpanded = card.getAttribute('aria-expanded') === 'true';
                        card.setAttribute('aria-expanded', !isExpanded);
                    }
                    if (editBtn) {
                        this.openGoalForEdit(editBtn.dataset.goalId);
                    }
                });
            },

            logActivity(dateKey, module) {
                if (!this.state.activityLog[module]) this.state.activityLog[module] = [];
                const log = new Set(this.state.activityLog[module]);
                log.add(dateKey);
                this.state.activityLog[module] = [...log];
            },

            renderAll() {
                this.renderDailyEntries();
                this.renderGoals();
            },

            renderDailyEntries() {
                const dateKey = this.getDateKey(this.state.currentDate);
                const entries = this.state.dailyEntries[dateKey] || {};
                document.getElementById('daily-ritual-textarea').value = entries.ritual || '';
                document.getElementById('daily-summary-textarea').value = entries.summary || '';
            },

            renderGoals() {
                const goalsList = document.getElementById('goals-list');
                const dateKey = this.getDateKey(this.state.currentDate);
                const goalsForToday = this.state.goals.filter(g => g.createdAt <= dateKey);

                if (goalsForToday.length === 0) {
                    goalsList.innerHTML = `<p style="color: var(--text-tertiary); text-align: center;">Nie masz jeszcze Å¼adnych celÃ³w. Dodaj nowy, aby zaczÄ…Ä‡!</p>`;
                    return;
                }
                
                goalsList.innerHTML = goalsForToday.map(goal => `
                    <article class="goal-card" id="${goal.id}" aria-expanded="false">
                        <button class="goal-header" aria-controls="plan-${goal.id}" aria-expanded="false">
                            <div class="goal-content">
                                <div class="goal-title">${goal.title}</div>
                                <p class="goal-details">${goal.details}</p>
                            </div>
                            <div class="goal-actions">
                                <button class="btn btn-icon edit-goal-btn" data-goal-id="${goal.id}" aria-label="Edytuj cel ${goal.title}"><svg fill="currentColor" width="16" height="16" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg></button>
                            </div>
                        </button>
                        <div class="goal-plan" id="plan-${goal.id}">
                            <div class="goal-plan-content">
                                ${goal.steps.length > 0 ? `
                                <ul class="steps-list">
                                    ${goal.steps.map(step => `
                                    <li class="step-item">
                                        <input type="checkbox" class="step-checkbox" id="${step.id}" data-goal-id="${goal.id}" data-step-id="${step.id}" ${step.completed ? 'checked' : ''}>
                                        <label for="${step.id}">${step.text}</label>
                                    </li>
                                    `).join('')}
                                </ul>
                                ` : '<p style="padding: 0 1.25rem 1.25rem; font-size: 0.9rem; color: var(--text-tertiary);">Brak zdefiniowanych krokÃ³w.</p>'}
                            </div>
                        </div>
                    </article>
                `).join('');

                // Sync aria-expanded on header button
                goalsList.querySelectorAll('.goal-card').forEach(card => {
                    const header = card.querySelector('.goal-header');
                    if (header) {
                        header.setAttribute('aria-expanded', card.getAttribute('aria-expanded'));
                    }
                });
            }
        };

        App.init();
    });
  </script>
</body>
</html>